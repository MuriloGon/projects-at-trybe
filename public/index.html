<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css">
  <title>Document</title>
  <style>
    html,
    body,
    #root {
      height: 100%;
      font-size: 14px;
    }

    .main {
      display: grid;
      grid-template-columns: 300px 1fr;
      height: 100%;
    }

    /* width */
    ::-webkit-scrollbar {
      width: 8px;
    }

    /* Track */
    ::-webkit-scrollbar-track {
      background: #c348d367;
    }

    /* Handle */
    ::-webkit-scrollbar-thumb {
      opacity: 0;
      background: #35123a;
      border-radius: 5px;
    }

    /* Handle on hover */
    ::-webkit-scrollbar-thumb:hover {
      background: #501c57;
    }

    .main>* {
      height: 100%;
    }

    .online {
      background: #401646;
      user-select: none;
      position: relative;
      overflow-y: scroll;
    }

    /* .online ::-webkit-scrollbar-track-piece {
      opacity: 0;
    } */

    .nickname-form {
      color: white;
      display: flex;
      width: 100%;
      padding-inline: 10px;
      border-bottom: solid 1px rgba(255, 255, 255, 0.5);
      position: sticky;
      top: 0;
      background: #401646;
      z-index: 10;
    }

    .nickname-form input {
      width: 100%;
    }

    .nickname-name {
      font-weight: 600;
    }

    .nickname-info {
      flex: 1;
      display: flex;
      flex-flow: column nowrap;
      justify-content: center;
    }

    .nickname-input {
      display: flex;
      align-items: center;
      justify-content: space-around;
    }

    .nickname-input input {
      background: none;
      color: white;
    }

    .nickname-info+* {
      padding-left: 5px;
    }

    .nickname-circ-stats {
      --side: 10px;
      width: var(--side);
      height: var(--side);
      background-color: #018f01;
      margin-right: 6px;
      border-radius: 50%;
    }

    .nickname-btn {
      flex: 1;
      border-radius: 50%;
      margin-block: 20px;
      height: 35px;
      width: 35px;
      background: white url(https://upload.wikimedia.org/wikipedia/commons/6/64/Edit_icon_%28the_Noun_Project_30184%29.svg);
      background-size: 20px 20px;
      background-repeat: no-repeat;
      background-position: center center;
      transition: filter 0.25s;
    }

    .nickname-btn:hover {
      filter: brightness(0.8);
    }

    .users-online {
      color: white;
    }

    .menu-item,
    .menu-item-icon {
      display: flex;
      align-items: center;
      padding: 3px;
    }

    .menu-item:hover {
      background: rgba(0, 0, 0, 0.39);
      cursor: pointer;
    }

    .slack-icon-container {
      display: flex;
      align-items: center;
    }

    .menu-item-icon {
      margin-right: 10px;
    }

    .user-icon {
      position: relative;
    }

    .user-icon-photo {
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 25%;
    }

    .user-icon-status {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 1px solid white;
      right: -2px;
      bottom: -4px;
      background: green;
    }

    .users-online-subcontainer:nth-child(1) {
      /* margin-top: 80px; */
    }

    .users-online-subcontainer {
      border-bottom: 1px solid rgba(255, 255, 255, 0.5);
      padding-block: 5px;
    }

    .chat {
      background: rgb(248, 197, 255);
      display: grid;
      grid-template-rows: 1fr max-content;
    }

    .message-input {
      padding: 10px;
      display: flex;
    }

    .message-input>input {
      border-radius: 5px;
      border: 1px solid rgba(0, 0, 0, 0.4);
      padding: 5px;
      width: 100%;
      outline: none;
    }

    .message-input>button {
      margin-left: 10px;
      width: 40px;
      height: 40px;
      background: #007a5aff;
      background-image: url(assets/send-btn.svg);
      background-size: 18px 18px;
      background-position: center center;
      background-repeat: no-repeat;
      border-radius: 5px;
    }

    .message-input>button:hover {
      filter: saturate(2);
    }

    .msg-item {
      padding: 10px;
    }

    .msg-avatar {
      width: 40px;
      height: 40px;
      background: rgb(255, 255, 255);
      border-radius: 5px;
      margin-top: 4px;
      background-size: contain;
    }

    .msg-item {
      display: grid;
      grid-template-columns: max-content 1fr;
      column-gap: 2px;
    }

    .msg-header {
      padding: 0 10px 0 10px;
    }

    .msg-header-nick {
      font-weight: 600;
    }

    .msg-header-time {
      color: rgb(66, 66, 66);
    }

    .msg-text {
      padding-inline: 10px;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script crossorigin src="https://unpkg.com/react-is/umd/react-is.production.min.js"></script>

  <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>

  <!-- <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script> -->
  <!-- <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script> -->

  <script crossorigin src="https://unpkg.com/styled-components/dist/styled-components.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

  <script src="socket.io/socket.io.js"></script>


  <script type="text/babel" data-name="GLOBAL_VARIABLES">
    const socket = io({
      extraHeaders: {
        nickname: sessionStorage.getItem('nickname') || 'null'
      }
    });
    const { useState, useEffect, useContext } = React;
  </script>

  <script type="text/babel" data-name="CONTEXT_REACT">
    const MyContext = React.createContext();

    function Provider({ children }) {
      const [data, setData] = useState({
        userId: '',
        nickname: '',
        connectedUsers: [], //{}
        messages: [] //  {userId: 'string', nickname: 'string', chatMessage: 'string', date: number, dateFormatted: string, message}: string}
      })

      const updateOnlineUsersList = (onlineUsersList) => {
        setData(dt => ({ ...dt, connectedUsers: onlineUsersList }));
      }

      const addMessage = (incomingMsg) => {
        setData(dt => ({ ...dt, messages: [...dt.messages, incomingMsg] }));
      }

      const updateNickname = (newNick) => {
        setData(dt => ({ ...dt, nickname: newNick }));
      }

      const updateMsgsNickname = (userId, newNickname) => {
        const dataCpy = { ...data };
        const indexsToUpdate = data.messages.find((msg) => msg.userId === userId);
        indexsToUpdate.forEach((index) => { dataCpy.messages[index].nickname = newNickname; });
        setData(dataCpy);
      }

      useEffect(() => {
        socket.on('message:better', (msg) => { addMessage(msg); })
        socket.on('user:firstConnection', ({ id, nickname }) => { setData(dt => ({ ...dt, userId: id, nickname })); });
        socket.on('online:update', (users) => updateOnlineUsersList(users));
      }, []);

      const context = {
        data: { ...data },
        addMessage,
        updateOnlineUsersList,
        updateMsgsNickname,
        updateNickname
      }

      return (
        <MyContext.Provider value={context}>
          {children}
        </MyContext.Provider>
      );
    }
  </script>

  <script type="text/babel" data-name="COMP_APP">
    function App() {
      return (
        <main className="main">
          <Online />
          <Chat />
        </main>
      );
    }
  </script>

  <script type="text/babel" data-name="COMP_ONLINE">
    function SetName() {
      const { data: { connectedUsers, nickname }, updateNickname } = useContext(MyContext);
      const [nick, setNick] = useState('');

      function updateUsernameServer(e) {
        e.preventDefault();
        sessionStorage.setItem('nickname', nickname);
        socket.emit('user:updateNickname', nickname);
      }

      return (
        <form onSubmit={updateUsernameServer} className="nickname-form">
          <div className="nickname-info">
            <div className="nickname-name">
              Fullstack Dev Inc
            </div>
            <div className="nickname-input">
              <div className="nickname-circ-stats" />
              <input
                data-testid="nickname-box"
                type="text"
                value={nick}
                placeholder={nickname}
                onChange={({ target: { value } }) => { updateNickname(value); setNick(value); }}
              />
            </div>
          </div>
          <div>
            <button data-testid="nickname-button" type="submit" className="nickname-btn"></button>
          </div>
        </form>
      );
    }

    function SlackIcon({ img = "assets/icons.svg", num = 1 }) {
      const size = 20;
      const iconStyles = {
        width: `${size}px`,
        height: `${size}px`,
        backgroundImage: `url(${img})`,
        backgroundPositionX: `${num * size}px`,
        backgroundSize: 'cover',
        display: 'inline-block',
      };
      return (
        <div className="slack-icon-container">
          <span className="online-item-img" style={iconStyles} />
        </div>
      );
    }

    function UserIcon() {
      return (
        <div className="user-icon">
          <div className="user-icon-photo" />
          <div className="user-icon-status" />
        </div>
      );
    }

    function MenuItem({ text, icon, testid = null, selected = false }) {
      const style = selected ? { fontWeight: '800', background: 'rgba(0, 0, 0, 0.39)' } : {};
      return (
        <li className="menu-item" data-testid={testid} style={style}>
          <div className="menu-item-icon">
            {icon}
          </div>
          <div>
            {text}
          </div>
        </li>
      );
    }

    function UsersOnline() {
      const { data: { connectedUsers, nickname, userId } } = useContext(MyContext);
      const labels = ['All unread', 'Threads', 'All DMs', 'Mentions & Reactions', 'Drafts', 'Saved Items', 'More',];

      const connected = [
        ...connectedUsers.filter(x => x.id === userId),
        ...connectedUsers.filter(x => x.id !== userId),
      ];

      return (
        <div className="users-online">
          <div className="users-online-subcontainer">
            <ul>
              {labels.map((lbl, index) => (
                <MenuItem key={'genneric-item-' + index} icon={<SlackIcon num={-index} />} text={lbl} />
              ))}
            </ul>
          </div>
          <div className="users-online-subcontainer">
            <MenuItem icon={<SlackIcon img="assets/channel-slack.svg" />} text="Webchat Project" selected />
            <MenuItem icon={<SlackIcon img="assets/channel-slack.svg" />} text="Software Engineers" />
            <MenuItem icon={<SlackIcon img="assets/channel-slack.svg" />} text="Node.Js Devs" />
            <MenuItem icon={<SlackIcon img="assets/channel-slack.svg" />} text=".Net Core Devs" />
          </div>
          <div className="users-online-subcontainer">
            <ul>
              {connected.map(({ id, nickname }) => (
                <MenuItem key={id} text={nickname} icon={<UserIcon />} testid="online-user" />
              ))}
            </ul>
          </div>
        </div>
      );
    };

    function Online() {
      return (
        <div className="online">
          <SetName />
          <UsersOnline />
        </div>
      );
    }
  </script>

  <script type="text/babel" data-name="COMP_CHAT">

    function Message({ msg }) {
      const { userId, nickname, chatMessage, date, dateFormatted, message } = msg;
      const uglyRequirement = <div data-testid="message" style={{ display: 'none' }}>{chatMessage}</div>;

      const data = moment(date).format('LT');

      return (
        <li className="msg-item">
          <div className="msg-avatar" style={{ backgroundImage: `url(https://i.pravatar.cc/150?u=${userId})` }} />
          <div className="msg-content">
            <div className="msg-header"><span className="msg-header-nick">{nickname}</span> <span className="msg-header-time">{data}</span></div>
            <div className="msg-text">{message}</div>
          </div>
          {uglyRequirement}
        </li>
      );
    }

    function MessageInput() {
      const [chatMessage, setChatMsg] = useState('');
      const { data: { nickname } } = useContext(MyContext);
      const btnStyle = chatMessage.length === 0 ? {
        filter: 'grayscale(1)',
        poiter: 'not-allowed'
      } : {}

      function sendMsg(e) {
        e.preventDefault();
        socket.emit('message', { chatMessage, nickname });
        setChatMsg('');
      }

      return (
        <form className="message-input" onSubmit={sendMsg}>
          <input data-testid="message-box" value={chatMessage} placeholder="Message #Webchat Team" onChange={({ target: { value } }) => setChatMsg(value)} />
          <button data-testid="send-button" type="submit" style={btnStyle} />
        </form>
      );
    }

    function Chat() {
      const { data: { messages } } = useContext(MyContext);

      return (
        <div className="chat">
          <ul>
            {messages.map((msg, index) => (
              <Message key={index} msg={msg} />
            ))}
          </ul>
          <MessageInput />
        </div>
      )
    }
  </script>

  <script type="text/babel" data-name="REACT_RENDER">
    ReactDOM.render(<Provider><App /></Provider>, document.getElementById('root'));
  </script>
</body>

</html>